<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SQUID CODE - Tournament Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f9e9.svg"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
    body {
      font-family: 'Orbitron', monospace;
      background: linear-gradient(135deg,#0a0a0a 0%,#1a0a0a 50%,#0a0a0a 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .glitch {
      position: relative;
      color: #ff1744;
      font-weight: bold;
      font-family: 'Orbitron', monospace;
      animation: glitch 2s infinite linear alternate-reverse;
      letter-spacing: 2px;
      text-shadow: 2px 2px 0 #fff, -2px -2px 0 #ff1744;
    }
    .glitch:before, .glitch:after {
      content: attr(data-text);
      position: absolute;
      left: 0; width: 100%;
      overflow: hidden;
      color: #fff;
      z-index: -1;
    }
    .glitch:before {
      animation: glitchTop 1.8s infinite linear alternate-reverse;
      top: -1px; left: 2px;
      text-shadow: 2px 0 #ff1744;
    }
    .glitch:after {
      animation: glitchBot 2.2s infinite linear alternate-reverse;
      top: 1px; left: -2px;
      text-shadow: -2px 0 #fff;
    }
    @keyframes glitch {
      0% { text-shadow: 2px 2px 0 #fff, -2px -2px 0 #ff1744; }
      20% { text-shadow: -2px 2px 0 #fff, 2px -2px 0 #ff1744; }
      40% { text-shadow: 2px -2px 0 #fff, -2px 2px 0 #ff1744; }
      60% { text-shadow: -2px -2px 0 #fff, 2px 2px 0 #ff1744; }
      80% { text-shadow: 2px 2px 0 #ff1744, -2px -2px 0 #fff; }
      100% { text-shadow: 2px 2px 0 #fff, -2px -2px 0 #ff1744; }
    }
    @keyframes glitchTop {
      0% { clip-path: inset(0 0 50% 0); }
      50% { clip-path: inset(0 0 10% 0); }
      100% { clip-path: inset(0 0 50% 0); }
    }
    @keyframes glitchBot {
      0% { clip-path: inset(50% 0 0 0); }
      50% { clip-path: inset(10% 0 0 0); }
      100% { clip-path: inset(50% 0 0 0); }
    }
    .neon-glow { box-shadow: 0 0 20px #ff1744,0 0 40px #ff1744,0 0 60px #ff1744;}
    .pulse-red { animation: pulse-red 2s infinite;}
    @keyframes pulse-red {
      0%,100% { box-shadow: 0 0 20px rgba(255,23,68,0.5);}
      50% { box-shadow: 0 0 40px rgba(255,23,68,0.8);}
    }
    .hidden { display:none;}
    .card-hover {transition: all 0.3s ease;}
    .card-hover:hover {transform: translateY(-5px);box-shadow: 0 20px 40px rgba(255, 23, 68, 0.3);}
    .disabled, .game-locked {
      opacity:0.4; cursor:not-allowed;
      filter: grayscale(1) blur(2px);
    }
    .game-won {
      background: linear-gradient(90deg, #ffd70022, #ff174422);
      border: 3px solid #ffd700;
      box-shadow: 0 0 25px #ffd700;
    }
    .simulation-illustration {
      width: 100%; height: 180px;
      background: repeating-linear-gradient(135deg, #222 0px, #222 16px, #111 16px, #111 32px);
      border-radius: 1rem;
      display: flex; align-items: center; justify-content: center;
      font-size: 3rem;
      color: #ff1744;
      margin-bottom: 1rem;
      user-select:none;
      cursor: pointer;
      position: relative;
    }
    .easter-egg {
      position: absolute;
      right: 10px;
      bottom: 10px;
      font-size: 1.5rem;
      color: #ffd700;
      filter: drop-shadow(0 0 10px #ffd700);
      cursor:pointer;
      transition: transform .2s;
      z-index: 2;
    }
    .easter-egg:hover {
      transform: scale(1.3) rotate(-12deg);
    }
    .blood-splatter {
      position: fixed;
      left: 50vw; top: 50vh;
      z-index: 99999;
      width: 80px; height: 80px;
      background: radial-gradient(circle, #ff0000 0%, #8b0000 70%, transparent 100%);
      border-radius: 50%;
      opacity: 0;
      animation: splatter 1.5s ease-out forwards;
      pointer-events:none;
    }
    @keyframes splatter {
      0% { opacity:0; transform:scale(0);}
      50% { opacity:1; transform:scale(1.2);}
      100%{ opacity:1; transform:scale(1);}
    }
    .splatter-text {
      position:fixed;
      top:calc(50vh + 40px); left:calc(50vw - 80px);
      width:220px;
      text-align:center;
      font-size:2rem;
      color:#fff;
      font-weight:bold;
      text-shadow:0 0 12px #ff1744,0 0 4px #000;
      z-index:99999;
      background:rgba(0,0,0,0.8);
      padding:0.5rem 1rem;
      border-radius:1rem;
      animation:showText 1.5s ease-out forwards;
    }
    @keyframes showText {
      0% { opacity:0;}
      40% { opacity:1;}
      100%{ opacity:1;}
    }
    .god-mode-indicator {
      position:fixed;
      bottom:10px; right:10px;
      background:#ffd700;
      color:#181818;
      font-weight:bold;
      padding:.5rem 1rem;
      border-radius:1rem;
      box-shadow:0 0 10px #ffd700bb;
      z-index:99999;
      font-size:1rem;
      letter-spacing:2px;
    }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;}
  </style>
</head>
<body>
  <div class="music-player hidden">
    <span>Background Music:</span>
    <button id="musicBtn">Play</button>
    <span id="musicName">SquidGame_theme.mp3</span>
  </div>
  <audio id="bgMusic" src="SquidGame_theme.mp3" loop preload="auto"></audio>
  <nav class="bg-gray-900 border-b border-red-600 p-4">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <div class="text-2xl font-black glitch" data-text="SQUID CODE">SQUID CODE</div>
        <div class="text-sm text-gray-400" id="navbarUser"></div>
      </div>
      <div class="flex space-x-6">
        <button onclick="showSection('dashboard')" id="nav-dashboard" class="nav-btn text-red-400 transition-colors">Dashboard</button>
        <button onclick="showSection('games')" id="nav-games" class="nav-btn text-white transition-colors">Games</button>
        <button onclick="showSection('leaderboard')" id="nav-leaderboard" class="nav-btn text-white transition-colors">Leaderboard</button>
        <button onclick="showSection('chat')" id="nav-chat" class="nav-btn text-white transition-colors">Secret Chat</button>
        <button onclick="showSection('lore')" id="nav-lore" class="nav-btn text-white transition-colors">The Truth</button>
      </div>
    </div>
  </nav>
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
    <div class="bg-gray-900 border border-red-600 p-8 rounded-lg max-w-sm w-full mx-4 shadow-lg" role="form" aria-labelledby="loginTitle">
      <h1 id="loginTitle" class="text-3xl font-bold mb-6 text-center text-red-400 glitch" data-text="LOGIN TO SQUID CODE">LOGIN TO SQUID CODE</h1>
      <form id="loginForm" autocomplete="off" novalidate>
        <div class="mb-4">
          <label for="role" class="text-sm text-gray-400 mb-2 block">Role <span aria-hidden="true">*</span></label>
          <select id="role" name="role" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white w-full focus:outline-none focus:ring-2 focus:ring-red-500" required aria-required="true">
            <option value="">Select role</option>
            <option value="player">Player</option>
            <option value="guard">Guard</option>
            <option value="admin">Admin</option>
          </select>
          <div id="roleError" class="error hidden text-red-400">Select a role.</div>
        </div>
        <div class="mb-6" id="playerNumSection" style="display:none;">
          <label for="playerNumber" class="text-sm text-gray-400 mb-2 block">Player Number <span aria-hidden="true">*</span></label>
          <input type="text" id="playerNumber" name="playerNumber" pattern="\\d{3}" maxlength="3" placeholder="e.g. 456" required class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white w-full focus:outline-none focus:ring-2 focus:ring-red-500" aria-required="true" aria-label="Player Number">
          <div id="playerNumberError" class="error hidden text-red-400">Enter a 3-digit number.</div>
        </div>
        <button type="submit" id="loginBtn" class="w-full bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-bold transition-colors neon-glow" aria-label="Login and Enter Game">ENTER GAME</button>
      </form>
    </div>
  </div>
  <div id="dashboard" class="section hidden"></div>
  <div id="games" class="section hidden"></div>
  <div id="leaderboard" class="section hidden"></div>
  <div id="chat" class="section hidden"></div>
  <div id="lore" class="section hidden"></div>
  <div id="godModeIndicator" class="god-mode-indicator hidden">GOD MODE ACTIVE (5)</div>
  <script>
    // Audio Setup
    const music = document.getElementById('bgMusic');
    const sounds = {
      login: new Howl({ src: ['login_success.mp3'], volume: 0.7 }),
      elimination: new Howl({ src: ['elimination.mp3'] }),
      win: new Howl({ src: ['game_win.mp3'] }),
      click: new Howl({ src: ['ui_click.mp3'], volume: 0.5 }),
      godMode: new Howl({ src: ['god_mode.mp3'] })
    };
     document.body.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('nav-btn')) {
            sounds.click.play();
        }
    });

    // Login logic
    let username = null, role = null;
    document.getElementById('role').addEventListener('change', function() {
      if (this.value === "player") {
        document.getElementById('playerNumSection').style.display = "block";
      } else {
        document.getElementById('playerNumSection').style.display = "none";
      }
    });
    function handleLogin(e) {
      e.preventDefault();
      document.getElementById('roleError').classList.add('hidden');
      document.getElementById('playerNumberError').classList.add('hidden');
      let _role = document.getElementById('role').value;
      if (!_role) {
        document.getElementById('roleError').classList.remove('hidden');
        document.getElementById('role').focus();
        return;
      }
      if (_role === "player") {
        let num = document.getElementById('playerNumber').value.trim();
        if (!/^\d{3}$/.test(num)) {
          document.getElementById('playerNumberError').classList.remove('hidden');
          document.getElementById('playerNumber').focus();
          return;
        }
        username = "#" + num;
      } else if (_role === "guard") {
        username = "Guard-" + (Math.floor(Math.random()*100)+1);
      } else {
        username = "Admin";
      }
      role = _role;
      document.getElementById('navbarUser').textContent = username + " (" + role.charAt(0).toUpperCase() + role.slice(1) + ")";
      document.getElementById('loginModal').classList.add('hidden');
      
      // Autoplay music and play login sound
      music.play();
      sounds.login.play();

      showSection('dashboard');
    }
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('playerNumber').addEventListener('keypress', function(e) {
      if (e.key === "Enter") document.getElementById('loginBtn').click();
    });
    document.getElementById('role').addEventListener('keypress', function(e) {
      if (e.key === "Enter") document.getElementById('loginBtn').click();
    });

    // State
    let gameState = {
      currentGame: 1,
      gamesPlayed: [false, false, false, false, false, false],
      eliminated: false,
      eliminatedPlayers: [],
      playerCredits: 5000000,
      alliances: [],
      foundEasterEgg: false,
      godMode: false,
      godModeUses: 0
    };

    function showSection(sectionId) {
      if (gameState.eliminated) return;
      document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
      document.querySelectorAll('.nav-btn').forEach(btn => { btn.classList.remove('text-red-400'); btn.classList.add('text-white'); });
      document.getElementById('nav-' + sectionId).classList.remove('text-white');
      document.getElementById('nav-' + sectionId).classList.add('text-red-400');
      if (sectionId === 'dashboard') renderDashboard();
      if (sectionId === 'games') renderGames();
      if (sectionId === 'leaderboard') renderLeaderboard();
      if (sectionId === 'chat') renderChat();
      if (sectionId === 'lore') renderLore();
      showGodModeIndicator();
    }
    function showGodModeIndicator() {
      let indicator = document.getElementById('godModeIndicator');
      if (gameState.godMode && role === "player" && gameState.godModeUses < 5) {
        indicator.textContent = `GOD MODE ACTIVE (${5-gameState.godModeUses})`;
        indicator.classList.remove("hidden");
      } else {
        indicator.classList.add("hidden");
      }
    }

    // DASHBOARD
    function renderDashboard() {
      const el = document.getElementById('dashboard');
      let html = "";
      if (role === "player") {
        html = `
        <div class="container mx-auto p-6">
          <h1 class="text-4xl font-black mb-8 text-center"><span class="glitch" data-text="PLAYER">PLAYER</span> DASHBOARD</h1>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="player-feature p-6 rounded-lg card-hover">
              <div class="text-red-400 text-sm uppercase tracking-wide">Health Status</div>
              <div id="playerHealth" class="text-3xl font-bold text-green-400">${gameState.eliminated ? 'ELIMINATED' : 'ALIVE'}</div>
              <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                <div id="healthBar" class="bg-green-500 h-2 rounded-full" style="width:${gameState.eliminated ? '0':'100'}%"></div>
              </div>
            </div>
            <div class="player-feature p-6 rounded-lg card-hover">
              <div class="text-red-400 text-sm uppercase tracking-wide">Credits</div>
              <div id="playerCredits" class="text-3xl font-bold text-yellow-400">₩${gameState.playerCredits.toLocaleString()}</div>
              <div class="text-sm text-gray-400">Prize Pool Share</div>
            </div>
            <div class="player-feature p-6 rounded-lg card-hover">
              <div class="text-red-400 text-sm uppercase tracking-wide">Alliances</div>
              <div id="playerAlliances" class="text-3xl font-bold text-blue-400">${gameState.alliances.length}</div>
              <div class="text-sm text-gray-400">Active Connections</div>
              <button onclick="alliancePopup()" class="mt-2 bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-xs font-bold transition-colors">Send Alliance Request</button>
              <div class="mt-2 text-xs text-yellow-300">${gameState.alliances.length>0?'Alliances: '+gameState.alliances.map(a=>a).join(', '):''}</div>
            </div>
            <div class="player-feature p-6 rounded-lg card-hover">
              <div class="text-red-400 text-sm uppercase tracking-wide">Players Remaining</div>
              <div id="playerRank" class="text-3xl font-bold text-purple-400">${456 - gameState.eliminatedPlayers.length}</div>
              <div class="text-sm text-gray-400">Out of 456</div>
            </div>
          </div>
          <div class="bg-gray-900 border border-red-600 p-8 rounded-lg mb-8 pulse-red">
            <h2 class="text-2xl font-bold mb-4 text-red-400">NEXT GAME</h2>
            <div class="text-xl mb-4">${getGameName(gameState.currentGame)}</div>
            <button onclick="showSection('games')" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-bold neon-glow">Go to Games</button>
          </div>
        </div>`;
      } else if (role === "guard") {
        html = `
        <div class="container mx-auto p-6">
          <h1 class="text-4xl font-black mb-8 text-center"><span class="glitch" data-text="GUARD">GUARD</span> DASHBOARD</h1>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="guard-feature p-6 rounded-lg card-hover">
              <div class="text-blue-400 text-sm uppercase tracking-wide">Monitor Players</div>
              <div class="text-2xl font-bold mb-2">Live Surveillance</div>
              <button onclick="showSection('leaderboard')" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-bold neon-glow">View Leaderboard</button>
            </div>
            <div class="guard-feature p-6 rounded-lg card-hover">
              <div class="text-blue-400 text-sm uppercase tracking-wide">Eliminate Players</div>
              <div class="text-2xl font-bold mb-2">Elimination Controls</div>
              <button onclick="showSection('games')" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-bold neon-glow">Eliminate/Final Watch</button>
            </div>
            <div class="guard-feature p-6 rounded-lg card-hover">
              <div class="text-blue-400 text-sm uppercase tracking-wide">Secret Comms</div>
              <div class="text-2xl font-bold mb-2">Guard Chat</div>
              <button onclick="showSection('chat')" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-bold neon-glow">Secret Chat</button>
            </div>
          </div>
          <div class="guard-feature p-6 rounded-lg mt-6">
            <h2 class="text-xl font-bold mb-4 text-blue-400">Guard Features</h2>
            <ul class="list-disc ml-6 text-gray-300">
              <li>Monitor all player activities</li>
              <li>Eliminate or watch people in any game (not play any)</li>
              <li>Access guard-only chat and controls</li>
              <li>View encrypted briefings</li>
            </ul>
          </div>
        </div>`;
      } else if (role === "admin") {
        html = `
        <div class="container mx-auto p-6">
          <h1 class="text-4xl font-black mb-8 text-center"><span class="glitch" data-text="ADMIN">ADMIN</span> DASHBOARD</h1>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="admin-feature p-6 rounded-lg card-hover">
              <div class="text-yellow-400 text-sm uppercase tracking-wide">Game Master Controls</div>
              <div class="text-2xl font-bold mb-2">Full System Access</div>
              <button onclick="showSection('games')" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded font-bold neon-glow">Simulate Any Game for Any User</button>
            </div>
            <div class="admin-feature p-6 rounded-lg card-hover">
              <div class="text-yellow-400 text-sm uppercase tracking-wide">Mass Events & Resets</div>
              <div class="text-2xl font-bold mb-2">Trigger Events</div>
              <button onclick="adminReset()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded font-bold neon-glow">Mass Reset</button>
            </div>
            <div class="admin-feature p-6 rounded-lg card-hover">
              <div class="text-yellow-400 text-sm uppercase tracking-wide">Analytics, Logs & Easter Eggs</div>
              <div class="text-2xl font-bold mb-2">Analytics & Moderation</div>
              <button onclick="showSection('chat')" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded font-bold neon-glow">AI Chat</button>
              <button onclick="showAdminEasterEgg()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded font-bold neon-glow mt-2">Easter Egg</button>
            </div>
          </div>
          <div class="admin-feature p-6 rounded-lg mt-6">
            <h2 class="text-xl font-bold mb-4 text-yellow-400">Admin Features</h2>
            <ul class="list-disc ml-6 text-gray-300">
              <li>Simulate any game for any user</li>
              <li>Trigger mass events and resets</li>
              <li>Review all chats (player/guard/admin)</li>
              <li>Access all analytics, logs, and easter eggs</li>
            </ul>
          </div>
        </div>`;
      }
      el.innerHTML = html;
    }

    function showAdminEasterEgg() {
      alert("Easter Egg: THE GOLDEN EGG 🥚");
    }

    function adminReset() {
      gameState.currentGame = 1;
      gameState.gamesPlayed = [false, false, false, false, false, false];
      gameState.eliminated = false;
      gameState.eliminatedPlayers = [];
      gameState.playerCredits = 5000000;
      gameState.alliances = [];
      gameState.foundEasterEgg = false;
      gameState.godMode = false;
      gameState.godModeUses = 0;
      alert("Mass reset triggered. All games restarted.");
      showSection('dashboard');
    }

    function renderGames() {
      const el = document.getElementById('games');
      let html = `<div class="container mx-auto p-6"><h1 class="text-4xl font-black mb-8 text-center"><span class="glitch" data-text="${role ? role.charAt(0).toUpperCase()+role.slice(1) : ""}">${role ? role.charAt(0).toUpperCase()+role.slice(1) : ""}</span> GAMES & SIMULATIONS</h1>`;
      html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
      const games = [
        {icon:"🚦",name:"Red Light, Green Light", playable: gameState.currentGame === 1, idx:1},
        {icon:"🍯",name:"Honeycomb Challenge", playable: gameState.currentGame === 2, idx:2},
        {icon:"🪢",name:"Tug of War", playable: gameState.currentGame === 3, idx:3},
        {icon:"🔮",name:"Marbles", playable: gameState.currentGame === 4, idx:4},
        {icon:"🌉",name:"Glass Bridge", playable: gameState.currentGame === 5, idx:5},
        {icon:"👑",name:"Squid Game Final", playable: gameState.currentGame === 6, idx:6},
      ];
      games.forEach((g, i) => {
        let locked = (role === 'player') && !gameState.gamesPlayed[i] && gameState.currentGame !== g.idx;
        let played = gameState.gamesPlayed[i];
        html += `
        <div class="bg-gray-900 border border-yellow-500 p-6 rounded-lg card-hover neon-glow
          ${locked ? 'game-locked' : ''}
          ${played ? 'game-won' : ''}">
          <div class="simulation-illustration" id="simIllustration${i}">
            ${g.icon}
            ${role === 'player' && i === 1 ? `<span class="easter-egg" onclick="findEasterEgg()" title="Easter Egg">🥚</span>` : ''}
          </div>
          <div class="mb-2 text-center text-lg">${g.name}</div>
          <div class="simulation-controls text-center">`;
        if (role === "player") {
          if (locked) {
            html += `<button class="bg-gray-600 px-4 py-2 rounded font-bold disabled" disabled>LOCKED</button>`;
          } else if (played) {
            html += `<button class="bg-yellow-600 px-4 py-2 rounded font-bold disabled" disabled>COMPLETED</button>`;
          } else {
            html += `<button id="playBtn${i}" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-bold">PLAY</button>`;
          }
        }
        else if (role === "guard") {
          html += `<div id="guardControls${i}">`
          if (i < 5) {
            html += `<button class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-bold" onclick="showGuardEliminationUI(${i}, '${g.name}')">Eliminate Player</button>`;
          } else {
            html += `<button class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-bold" onclick="showWinner()">Watch Final Showdown</button>`;
          }
          html += `</div>`
        }
        else if (role === "admin") {
          html += `<input type="text" id="adminTarget${i}" placeholder="Player # (e.g. 123)" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white w-1/2 mr-2">
          <button class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded font-bold" onclick="simulateAdminGame(${i})">Simulate for Player</button>`;
        }
        html += `</div>
          <div id="simStatus${i}" class="text-center mb-2"></div>
          <div id="simResult${i}" class="text-center text-lg font-bold mt-2"></div>
        </div>`;
      });
      html += "</div></div>";
      el.innerHTML = html;
      if (role === "player") {
        games.forEach((g, i) => {
          let btn = document.getElementById('playBtn'+i);
          if (btn && !gameState.gamesPlayed[i] && gameState.currentGame === g.idx) {
            btn.onclick = function() {
              playGame(i);
            };
          }
        });
      }
    }
    // Functional games for players:
    function playGame(idx) {
      let resultDiv = document.getElementById('simResult'+idx);
      let statusDiv = document.getElementById('simStatus'+idx);
      if (idx === 0) { // RLGL
        let moves = 0;
        let isGreen = true;
        statusDiv.innerHTML = `<span id="rlglLight" class="text-green-400">GREEN LIGHT</span>`;
        resultDiv.innerHTML = `<button id="rlglMove" class="bg-green-600 px-4 py-2 rounded font-bold mx-2">MOVE</button>
        <button id="rlglStop" class="bg-red-600 px-4 py-2 rounded font-bold mx-2">STOP</button>
        <span id="rlglProgress" class="ml-4">0/5 moves</span>`;
        let interval = setInterval(()=>{
          isGreen = Math.random()>0.3;
          document.getElementById('rlglLight').textContent = isGreen ? "GREEN LIGHT" : "RED LIGHT";
          document.getElementById('rlglLight').className = isGreen ? "text-green-400" : "text-red-400";
        },900);
        document.getElementById('rlglMove').onclick = ()=>{
          if (isGreen) {
            moves++;
            document.getElementById('rlglProgress').textContent = moves+"/5 moves";
            if (moves>=5) { clearInterval(interval); finishGame(idx,true); }
          } else {
            clearInterval(interval);
            finishGame(idx, false);
          }
        };
        document.getElementById('rlglStop').onclick = ()=>{ /* just wait */ };
      }
      else if (idx===1) { // Honeycomb Challenge
        resultDiv.innerHTML = `
          <button class="bg-yellow-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(1,Math.random()<0.7)">Careful</button>
          <button class="bg-orange-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(1,Math.random()<0.5)">Normal</button>
          <button class="bg-red-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(1,Math.random()<0.3)">Rush</button>
          <button class="bg-green-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(1,Math.random()<0.8)">Lick Technique</button>
        `;
      }
      else if (idx===2) { // Tug of War
        let myTeam = 50, opp = 50;
        resultDiv.innerHTML = `<button class="bg-blue-600 px-4 py-2 rounded font-bold mx-2" id="pullBtn">PULL</button>
        <span id="tugScore" class="ml-4">${myTeam} vs ${opp}</span>`;
        document.getElementById('pullBtn').onclick = ()=>{
          myTeam+=Math.floor(Math.random()*10)+5;
          opp+=Math.floor(Math.random()*8);
          document.getElementById('tugScore').textContent = `${myTeam} vs ${opp}`;
          if(myTeam>opp+20) finishGame(idx,true);
          else if(opp>myTeam+20) finishGame(idx,false);
        }
      }
      else if (idx===3) { // Marbles
        resultDiv.innerHTML = `<button class="bg-green-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(3,Math.random()<0.6)">Odd/Even</button>
        <button class="bg-purple-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(3,Math.random()<0.4)">Guess</button>`;
      }
      else if (idx===4) { // Glass Bridge
        resultDiv.innerHTML = `<button class="bg-green-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(4,Math.random()<0.5)">Left</button>
        <button class="bg-red-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(4,Math.random()<0.5)">Right</button>`;
      }
      else if (idx===5) { // Squid Game Final
        resultDiv.innerHTML = `<button class="bg-red-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(5,Math.random()<0.5)">Attack</button>
        <button class="bg-blue-600 px-4 py-2 rounded font-bold mx-2" onclick="finishGame(5,Math.random()<0.7)">Defend</button>`;
      }
    }
    
    function simulateRoundEnd() {
        if (role !== 'player') return; // Only simulate for player progression

        const currentRound = gameState.currentGame - 1; // The round that just finished
        
        // Define how many players get eliminated each round (can be adjusted)
        const eliminationCounts = [90, 70, 60, 40, 20, 1]; 
        const numToEliminate = eliminationCounts[currentRound - 1] || 0;

        // Get a list of players who are currently alive
        let alivePlayers = [];
        for (let i = 1; i <= 456; i++) {
            let playerNum = "#" + i.toString().padStart(3, '0');
            if (!gameState.eliminatedPlayers.includes(playerNum) && playerNum !== username) {
                alivePlayers.push(playerNum);
            }
        }

        // Shuffle and pick players to eliminate
        alivePlayers.sort(() => 0.5 - Math.random());
        const newlyEliminated = alivePlayers.slice(0, numToEliminate);

        // Add them to the global eliminated list
        gameState.eliminatedPlayers.push(...newlyEliminated);
    }

    window.finishGame = function(idx, survived) {
      let resultDiv = document.getElementById('simResult'+idx);
      let statusDiv = document.getElementById('simStatus'+idx);
      let illustrationDiv = document.getElementById('simIllustration'+idx);
      
      let godModeSaved = false;
      if (!survived && gameState.godMode && gameState.godModeUses < 5) {
          survived = true;
          gameState.godModeUses++;
          godModeSaved = true;
      }

      if (survived) {
        sounds.win.play();
        resultDiv.textContent = godModeSaved ? "SAVED BY GOD MODE!" : "You Survived!";
        if (godModeSaved) resultDiv.classList.add('text-yellow-400');
        statusDiv.textContent = "Proceed to next game.";
        illustrationDiv.textContent = "🟢";
        gameState.gamesPlayed[idx] = true;
        gameState.playerCredits = Math.round(gameState.playerCredits*1.4);
        if (gameState.currentGame < 6) {
          gameState.currentGame++;
          simulateRoundEnd();
        } else { 
          confettiWin();
        }
        renderDashboard();
        renderGames();
        renderLeaderboard();
      } else {
        sounds.elimination.play();
        resultDiv.textContent = "Eliminated!";
        statusDiv.textContent = "";
        illustrationDiv.textContent = "💀";
        showBloodSplatter();
        setTimeout(offWebsite, 1500);
      }
      showGodModeIndicator();
    };

    function showGuardEliminationUI(gameIndex, gameName) {
        const controlsDiv = document.getElementById('guardControls' + gameIndex);
        controlsDiv.innerHTML = `
            <input type="text" id="guardElimTarget${gameIndex}" placeholder="e.g. 456" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white w-1/2 mr-2">
            <button class="bg-red-800 hover:bg-red-900 px-4 py-2 rounded font-bold" onclick="confirmGuardElimination(${gameIndex}, '${gameName}')">Confirm</button>
        `;
        document.getElementById('guardElimTarget' + gameIndex).focus();
    }

    function confirmGuardElimination(gameIndex, gameName) {
        const targetInput = document.getElementById('guardElimTarget' + gameIndex);
        const resultDiv = document.getElementById('simResult' + gameIndex);
        const rawTarget = targetInput.value.trim();
        const targetNum = parseInt(rawTarget, 10);

        if (isNaN(targetNum) || targetNum < 1 || targetNum > 456) {
            resultDiv.innerHTML = `<span class="text-yellow-400">Enter a number between 1-456.</span>`;
            setTimeout(() => { resultDiv.innerHTML = ''; }, 2000);
            return;
        }
        
        const target = "#" + targetNum.toString().padStart(3, '0');

        if (gameState.eliminatedPlayers.includes(target)) {
            resultDiv.innerHTML = `<span class="text-yellow-400">${target} is already eliminated.</span>`;
            setTimeout(() => { resultDiv.innerHTML = ''; }, 2000);
            return;
        }
        
        sounds.elimination.play();
        gameState.eliminatedPlayers.push(target);
        resultDiv.innerHTML = `<span class="text-red-500">${target} has been eliminated.</span>`;
        renderLeaderboard();

        setTimeout(() => {
            const controlsDiv = document.getElementById('guardControls' + gameIndex);
            controlsDiv.innerHTML = `<button class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-bold" onclick="showGuardEliminationUI(${gameIndex}, '${gameName}')">Eliminate Player</button>`;
            resultDiv.innerHTML = '';
        }, 3000);
    }

    function simulateAdminGame(idx) {
      let inputId = 'adminTarget'+idx;
      let playerId = document.getElementById(inputId).value.trim();
      let playerIdNum = parseInt(playerId, 10);
      if (isNaN(playerIdNum) || playerIdNum < 1 || playerIdNum > 456) {
          alert("Enter a valid player number (e.g. 123)");
          return;
      }
      const formattedPlayerId = "#" + playerIdNum.toString().padStart(3, '0');
      
      let survived = Math.random() < 0.7;
      let resultDiv = document.getElementById('simResult'+idx);
      let statusDiv = document.getElementById('simStatus'+idx);
      let illustrationDiv = document.getElementById('simIllustration'+idx);
      if (survived) {
        resultDiv.textContent = formattedPlayerId+" Survived!";
        statusDiv.textContent = "Proceed to next game.";
        illustrationDiv.textContent = "🟢";
      } else {
        resultDiv.textContent = formattedPlayerId+" Eliminated!";
        statusDiv.textContent = "";
        illustrationDiv.textContent = "💀";
        gameState.eliminatedPlayers.push(formattedPlayerId);
        renderLeaderboard();
      }
    }
    function showBloodSplatter() {
      let splatter = document.createElement('div');
      splatter.className = 'blood-splatter';
      document.body.appendChild(splatter);
      let text = document.createElement('div');
      text.className = 'splatter-text';
      text.textContent = "ELIMINATED\nRESTART";
      document.body.appendChild(text);
      setTimeout(() => {
        splatter.remove();
        text.remove();
      }, 3500);
    }
    function offWebsite() {
      gameState.eliminated = true;
      document.body.innerHTML = `<div class="blood-splatter"></div>
      <div class="splatter-text">ELIMINATED<br>RESTART</div>`;
      setTimeout(() => { window.location.reload(); }, 3000);
    }
    function getGameName(idx) {
      return ["Red Light, Green Light","Honeycomb Challenge","Tug of War","Marbles","Glass Bridge","Squid Game Final"][idx-1] || "Tournament Complete";
    }
    function showWinner() {
      let winnerNum = "#" + (Math.floor(Math.random()*456)+1).toString().padStart(3,"0");
      alert("Final Winner: " + winnerNum);
    }
    function confettiWin() {
      for(let i=0;i<5;i++) {
        setTimeout(()=>{confetti({particleCount: 80,spread: 90,origin:{y:0.2+0.15*i,x:0.5}});},i*400);
      }
      setTimeout(()=>{alert('CONGRATULATIONS! You won Squid Game!');},2500);
    }
    function findEasterEgg() {
      if (gameState.foundEasterEgg) return;
      sounds.godMode.play();
      gameState.foundEasterEgg = true;
      gameState.godMode = true;
      gameState.godModeUses = 0;
      confetti({particleCount: 100,spread: 120,origin:{y:0.8,x:0.7}});
      alert("GOD MODE ENABLED!\nYou can resist elimination for the next 5 games!");
      showGodModeIndicator();
    }

    // ALLIANCE POPUP
    function alliancePopup() {
      if (gameState.eliminated) return;
      let popup = document.createElement('div');
      popup.className = 'alliance-popup';
      popup.innerHTML = `<h2 class="text-xl font-bold text-yellow-400 mb-4">Send Alliance Request</h2>
        <input type="text" placeholder="#123" id="allianceTarget"><br>
        <button onclick="sendAlliance()">Send Request</button>
        <button onclick="closeAlliancePopup()" style="background:#222; color:#ffd700; margin-left:8px;">Cancel</button>
        <div class="mt-2 text-xs text-yellow-200">Type 3-digit player number (e.g. #123)</div>`;
      document.body.appendChild(popup);
      document.getElementById('allianceTarget').focus();
    }
    function closeAlliancePopup() {
      let popups = document.querySelectorAll('.alliance-popup');
      popups.forEach(p=>p.remove());
    }
    function sendAlliance() {
      let target = document.getElementById('allianceTarget').value.trim();
      if (!/^#\d{3}$/.test(target)) {
        alert('Enter valid player number (e.g. #123)');
        return;
      }
      if (gameState.alliances.includes(target)) {
        alert('Already allied!');
        closeAlliancePopup();
        return;
      }
      gameState.alliances.push(target);
      alert('Alliance request sent to '+target);
      closeAlliancePopup();
      renderDashboard();
    }

    // LEADERBOARD: Shows eliminations after games
    function renderLeaderboard() {
      let html = `<div class="container mx-auto p-6"><h1 class="text-4xl font-black mb-8 text-center"><span class="glitch" data-text="SURVIVAL">SURVIVAL</span> LEADERBOARD</h1>
      <div class="bg-gray-900 border border-red-600 rounded-lg overflow-hidden">
      <div class="bg-red-600 p-4">
        <div class="grid grid-cols-5 gap-4 font-bold">
          <div>Rank</div>
          <div>Player</div>
          <div>Status</div>
          <div>Games Won</div>
          <div>Threat Level</div>
        </div>
      </div>
      <div class="divide-y divide-gray-700">`;
      
      let players = [];
      const completedGames = gameState.gamesPlayed.filter(g => g).length;

      for(let i=1; i<=456; i++) {
        let playerNum = "#" + i.toString().padStart(3,"0");
        let isMe = (role === "player" && username === playerNum);
        let eliminated = gameState.eliminatedPlayers.includes(playerNum) || (isMe && gameState.eliminated);
        let wonGames = isMe ? completedGames : Math.floor(Math.random() * (completedGames + 1));
        if (eliminated) wonGames = Math.min(wonGames, Math.floor(Math.random() * 6)); // Eliminated players have a fixed random win count

        players.push({
            num: playerNum,
            isMe: isMe,
            eliminated: eliminated,
            wonGames: wonGames,
            threat: "★".repeat(Math.floor(Math.random() * 5) + 1).padEnd(5, "☆")
        });
      }
      // Sort by status (alive first), then by games won (desc), then by number (asc)
      players.sort((a,b) => (a.eliminated - b.eliminated) || (b.wonGames - a.wonGames) || (a.num.localeCompare(b.num)));

      players.forEach((p, rank) => {
        html += `<div class="grid grid-cols-5 gap-4 p-4 leaderboard-row${p.isMe?' gold':''}">
          <div class="font-bold">${rank+1}</div>
          <div>${p.num}${p.isMe ? ' <span class="text-blue-400">(YOU)</span>' : ''}${gameState.alliances.includes(p.num) ? ' <span class="text-yellow-400">(Alliance)</span>' : ''}</div>
          <div>${!p.eliminated ? '<span class="text-green-400">● ALIVE</span>' : '<span class="text-red-400">● ELIMINATED</span>'}</div>
          <div>${p.eliminated && p.wonGames > completedGames ? completedGames : p.wonGames}/${p.eliminated ? '6' : completedGames}</div>
          <div><span class="text-red-500">${p.threat}</span></div>
        </div>`;
      });
      html += `</div></div></div>`;
      document.getElementById('leaderboard').innerHTML = html;
    }

    // CHAT: Connect to real AI API (OpenAI) for Squid Game responses
    function renderChat() {
      const el = document.getElementById('chat');
      el.innerHTML = `<div class="container mx-auto p-6">
        <h1 class="text-4xl font-black mb-8 text-center glitch" data-text="SECRET SQUID AI CHAT">SECRET SQUID AI CHAT</h1>
        <div class="bg-gray-900 border border-red-600 rounded-lg h-80 overflow-y-auto p-4 mb-4" id="chatMessages"></div>
        <div class="flex space-x-2 mt-4">
          <input type="text" id="messageInput" placeholder="Ask the AI anything..." class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500">
          <button onclick="sendMessage()" id="sendBtn" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-bold transition-colors neon-glow">SEND</button>
        </div>
        <p class="text-xs text-gray-400 mt-2">AI responds with deep Squid Game logic.</p>
      </div>`;
      setupChat();
      document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === "Enter") document.getElementById('sendBtn').click();
      });
    }
    function setupChat() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = `<div class="flex items-start space-x-3">
        <div class="bg-gray-600 rounded-full w-8 h-8 flex items-center justify-center text-xs font-bold">SYS</div>
        <div class="flex-1"><div class="text-sm text-gray-400">System • now</div>
        <div class="bg-gray-800 p-3 rounded-lg">Welcome to the Squid AI. Ask, doubt, or strategize.</div></div>
      </div>`;
    }
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-3';
        messageDiv.innerHTML = `<div class="bg-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-xs font-bold">${username}</div>
          <div class="flex-1"><div class="text-sm text-gray-400">${username} • now</div>
          <div class="bg-blue-900 bg-opacity-50 p-3 rounded-lg">${message}</div></div>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        input.value = '';
        input.disabled = true;
        document.getElementById('sendBtn').disabled = true;

        let aiResponse = await fetchSquidAI(message);
        const responseDiv = document.createElement('div');
        responseDiv.className = 'flex items-start space-x-3';
        responseDiv.innerHTML = `<div class="bg-red-600 rounded-full w-8 h-8 flex items-center justify-center text-xs font-bold">AI</div>
            <div class="flex-1"><div class="text-sm text-gray-400">AI • now</div>
            <div class="bg-gray-800 p-3 rounded-lg chat-ai">${aiResponse}</div></div>`;
        chatMessages.appendChild(responseDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        input.focus();
      }
    }
    async function fetchSquidAI(userMsg) {
      // Mock AI for demonstration as no API key is available.
      const lowerMsg = userMsg.toLowerCase();
      let aiResponse = "That is an interesting thought. But in this game, only survival matters.";

      if (lowerMsg.includes("win") || lowerMsg.includes("survive")) {
        aiResponse = "Winning is a matter of will. And a little bit of luck. Do you have what it takes?";
      } else if (lowerMsg.includes("trust") || lowerMsg.includes("alliance")) {
        aiResponse = "Trust is a luxury few can afford here. An alliance can be a shield or a dagger in your back.";
      } else if (lowerMsg.includes("lose") || lowerMsg.includes("die") || lowerMsg.includes("eliminate")) {
        aiResponse = "Elimination is part of the game. Every player's departure increases the prize for the rest. Do not falter.";
      } else if (lowerMsg.includes("money") || lowerMsg.includes("prize")) {
        aiResponse = "The prize pool grows with every failure. Focus on the game, not the reward. The reward is a consequence of survival.";
      } else if (lowerMsg.includes("who are you") || lowerMsg.includes("frontman")) {
        aiResponse = "I am a part of the system. I ensure the games are fair. Equality for all players. That is the rule.";
      } else if (lowerMsg.includes("help") || lowerMsg.includes("stuck")) {
        aiResponse = "Help is not given, it is earned. Or taken. Find your own way to survive.";
      }

      // Simulate network latency
      return new Promise(resolve => {
        setTimeout(() => {
          resolve(aiResponse);
        }, 600 + Math.random() * 400);
      });
    }
    function renderLore() {
      document.getElementById('lore').innerHTML = `<div class="container mx-auto p-6">
        <h1 class="text-4xl font-black mb-8 text-center glitch" data-text="THE TRUTH">THE TRUTH</h1>
        <div class="max-w-4xl mx-auto space-y-8">
          <div class="bg-gray-900 border border-red-600 p-8 rounded-lg">
            <h2 class="text-2xl font-bold mb-4 text-red-400">Origin Protocol</h2>
            <p class="text-gray-300 leading-relaxed mb-4">
              In 2025, the games evolved beyond physical boundaries. What began as desperate survival has transformed into the ultimate test of human ingenuity, strategy, and code.
            </p>
            <p class="text-gray-300 leading-relaxed">
              The Frontman discovered in our digital age, the most valuable currency isn't money—it's data, algorithms, and the ability to manipulate reality through code.
            </p>
          </div>
          <div class="bg-gray-900 border border-red-600 p-8 rounded-lg">
            <h2 class="text-2xl font-bold mb-4 text-red-400">Selection Process</h2>
            <p class="text-gray-300 leading-relaxed mb-4">
              Your digital footprint, coding abilities, and desperation levels were analyzed by AI for months.
            </p>
            <div class="bg-red-900 bg-opacity-30 p-4 rounded border border-red-500">
              <p class="text-red-300 text-sm"><strong>CLASSIFIED:</strong> Algorithm considers debt-to-skill ratio, social isolation, survival instinct.</p>
            </div>
          </div>
          <div class="bg-gray-900 border border-red-600 p-8 rounded-lg">
            <h2 class="text-2xl font-bold mb-4 text-red-400">Hidden Messages</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-gray-800 p-4 rounded">
                <div class="font-mono text-green-400 text-sm mb-2">01001000 01100101 01101100 01110000</div>
                <div class="text-xs text-gray-400">Binary message from eliminated player</div>
                <button onclick="alert('Decoded: HELP')" class="mt-2 bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-xs transition-colors">DECODE</button>
              </div>
              <div class="bg-gray-800 p-4 rounded">
                <div class="font-mono text-yellow-400 text-sm mb-2">The cake is a lie. Trust no one.</div>
                <div class="text-xs text-gray-400">Last transmission from Player #001</div>
              </div>
            </div>
          </div>
        </div>
      </div>`;
    }
    // Show login modal first
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('games').classList.add('hidden');
    document.getElementById('leaderboard').classList.add('hidden');
    document.getElementById('chat').classList.add('hidden');
    document.getElementById('lore').classList.add('hidden');
    document.getElementById('loginModal').classList.remove('hidden');
  </script>
</body>
</html>